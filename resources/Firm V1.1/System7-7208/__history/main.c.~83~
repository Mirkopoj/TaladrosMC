#include <main.h>

int16 dc1, dc2;
int16 C1, C2;
int16 C1s = 0;
int16 C2s = 0;
int1 f = 0;

void main()
{
   setup_adc(ADC_CLOCK_INTERNAL);
   setup_adc_ports(sAN5 | sAN6 | VSS_VDD);      //AN5 es C1; AN6 es C2
      
   setup_timer_2(T2_DIV_BY_64,156,1);
   setup_pwm1(PWM_ENABLED | PWM_ACTIVE_HIGH | PWM_OUTPUT);
   
   set_adc_channel(5);
   delay_ms(1);
   C1 = read_adc();
   delay_ms(1);
   set_adc_channel(6);
   delay_ms(1);
   C2 = read_adc();
   delay_ms(1);
   
   while(C1>540 && C2>540)
   {
      set_pwm1_duty(62);
      f = 1;
   }
   
   if (f==1)
   {
      set_pwm1_duty(32);
      delay_ms(2000);
   }
   
   set_pwm1_duty(47);
   delay_ms(500);
   
   while(TRUE)
   {
      for(int i=0;i<10;i++)
      {
         set_adc_channel(5);
         delay_ms(1);
         C1 = read_adc();
         C1s = C1s + C1;
         delay_ms(1);
         set_adc_channel(6);
         delay_ms(1);
         C2 = read_adc();
         C2s = C2s + C2;
         delay_ms(1);
      }
      C1=C1s/10;
      C2=C2s/10;
      C1s = 0;
      C2s = 0;
      
      if(C1>530)
      {
         dc1 = ((C1*22)/100) - 81;
      }
      else if(C2>530)
      {
         dc1 = 81 - ((C2*22)/100);
      }
      else
      {
         dc1 = 47;
      }
      if (dc1<32) {dc1=32;}
      if (dc1>62) {dc1=62;}
      
      set_pwm1_duty(dc1);
   }
}
